<!DOCTYPE html>
<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
		<title>jQuery UI Example Page</title>
		<script type="text/javascript" src="./js/jquery-1.3.2.min.js"></script>
		<script type="text/javascript" src="./js/jquery-ui-1.7.2.custom.min.js"></script>
		<script type="text/javascript" src="./jpivot.js"></script>
		<script type="text/javascript" src="./FusionCharts/fusioncharts.js"></script>
		<link type="text/css" rel="stylesheet" href="./css/jobretail/ui.all.css" />

    
    <script language="javascript" type="text/javascript" src="./js/jquery.colorPicker.js"/></script>		
		<link rel="stylesheet" href="./css/colorPicker.css" type="text/css" />
		<link type="text/css" href="./css/jpivot-external.css" rel="stylesheet" />	
		
    <script language="javascript" type="text/javascript" src="./js/jquery.tochecklist.js"/></script>		
		<link rel="stylesheet" href="./css/jquery.toChecklist.min.css" type="text/css" />
		
    <script language="javascript" type="text/javascript" src="./js/jquery.json-2.2.min.js"/></script>		
		
		
<!--
//!!!!!!!!!!!!!!!!!!!!!!!!!
////  http://www.fusioncharts.com/forum/Topic5009-47-1.aspx#bm8077
//!!!!!!!!!!!!!!!!!!!!!!
-->

		
		<script type="text/javascript">
		  
		  
var month_subst = ['янв','фев','мрт','апр','май','июн','июл','авг','сен','окт','ноя','дек'];

			

var debug=0;

var pv0=null;

var serial={};

var pv_json=[];
$(document).ready(function()
	{
	var pivots=$('#pv').jPivot({
			data:data,rows:rows,cols:cols,data_col:data_col,data_headers:data_headers,agregate:agregate
			,filter:filter
	    ,styles:{Key:'class="ui-state-default"'}
	    ,ExternalManage:true
	    ,immediate_draw:false
	    ,row_keys_placeholder:'qpv_row_keys_placeholder'
	    ,col_keys_placeholder:'qpv_col_keys_placeholder'
	    ,AfterDraw:function(){AfterDraw()}
	    ,BeforeDraw:function(){BeforeDraw()}
	    ,BeforePrepare:function(){BeforePrepare()}
	    ,AfterPrepare:function(){AfterPrepare()}
	    ,getCustomFilter:function(pvdata_row)
	    		{
	    		if (!use_custom_filter) return false;// do not filter
	    		var val=this.data[pvdata_row][data_col];
	    		if ((custom_filter_cmp==0) && (val >= custom_filter_val)) return false;
	    		if ((custom_filter_cmp==1) && (val != custom_filter_val)) return false;
             if ((custom_filter_cmp==2) && (val <= custom_filter_val)) return false;
             if ((custom_filter_cmp==3) && (val == custom_filter_val)) return false;
             return true; //do not pass row
             }
       ,getDataForExcel:function()
                  {
                  var tr=0; var td=0; var tmp; var cs;var rs;var cl;var bg;
                  $('#jpivot_placeholder tr').each(function (i)
                           {
                           pv_json[tr]=[];td=0;
                           $('td',this).each(function (i)
                                       {
                                       tmp = $(this);
                                       cs=tmp.attr('colspan'); cs=(typeof cs === 'undefined') ? 1 : cs;
                                       rs=tmp.attr('rowspan'); rs=(typeof rs === 'undefined') ? 1 : rs;
                                       cl=tmp.attr('class'); cl=(typeof cl === 'undefined') ? '' : cl;
                                       bg=tmp.css('background-color'); bg=(typeof bg === 'undefined') ? '' : bg;
                                       pv_json[tr][td++]=[tmp.text(),cs,rs,cl,bg];
                                       });
                           tr++;
                           });
                   $.postJSON(
                   'ajax.php?mode=export_excel'
                   ,{pv_table:JSON.stringify(pv_json)}
                   )
                   }
		,printValue:function(data_indexes,rn,cn)
					{
					var rclass = this.styles.Value;
					if ($('#use_percent_by_totals').is(':checked') &&    ($('#totals_dropdown').val() != null)) 
					   {
					   return print_value_by_total(this,data_indexes,rn,cn);
					   }
		      
    			if (typeof data_indexes == 'undefined') return  ['',rclass];		;
    			var ret=0;
					if (debug==1) ret='trv'
					if (debug==2) ret='trv'+data_indexes.join(' +');
					if (!debug)
    					{
    					ret = precalc_val_func (data_indexes);
    				  }
    		  return  [ret,rclass];	
					}
					/*                   
      ,printValue:function(data_indexes)
               {
            var rclass = this.styles.Value
            if (typeof data_indexes == 'undefined') return  ['',rclass];      ;
             var ret=0;
             var len =data_indexes.length 
                   for (var i=0;i < len; i++) 
                         ret += parseFloat(this.data[data_indexes[i]][data_col]);   
            var c;
             for (i=0; i < colors.length; i++)
                 {
                 c=colors[i][1]
                if (ret > colors[i][0])  
                    break;
                }
            rclass +=' style="background-color:'+c+'"';
            return  [ret,rclass];   
               } 
      */                 
         });  
 //redraw_pivot();
   pv0=pivots[0];
   pv0.drawData();
   //init colorpickers
    $('#colors input').each(function(i)
        {
        colors[i]=$(this).colorPicker();
        }
    )      

   $("#resize_chart_1").resizable({
    
    stop:function(){redraw()}
    ,handles: 'all' 
   });
   }
   );
var colors=[];   
var use_custom_filter=0;custom_filter_cmp=0;custom_filter_val=0;

var tot_perc = null;
function BeforePrepare()
   {
   use_custom_filter = $('#use_custom_filter').is(':checked');
   custom_filter_cmp = parseInt($('#custom_filter_cmp').val());
   custom_filter_val = parseFloat($('#custom_filter_val').val());
   }
   
function precalc_totals(precalc_total,tot_ptr)
    {
      //loop by
      var len;var vals; var ret;
      for (var r=0; r < tot_ptr.length ; r++)
         {
         precalc_total[r]=[];
         for (var c=0; c < tot_ptr[r].length; c++)
             {
              precalc_total[r][c]=[];
    					len =tot_ptr[r][c].length 
    					ret=0;
    					for (var i=0;i < len; i++) 
    					    {
    					    vals = tot_ptr[r][c][i];
    					    if (typeof vals === 'undefined') continue;
    					    for (var j =0 ; j < vals.length; j++)
    							ret += parseFloat(pv0.opts.data[vals[j]][pv0.opts.data_col]);	
    						  } 
              precalc_total[r][c]=ret;    				      
              } 
         }   						  
    }  
function  precalc_val_func (data_indexes)
    {
   					var len =data_indexes.length;
   					var ret=0; 
    					for (i=0;i < len; i++) 
    							ret += parseFloat(pv0.opts.data[data_indexes[i]][pv0.opts.data_col]);	
    			  return ret;
    }     
function AfterPrepare()
   {
   if (!$('#use_percent_by_totals').is(':checked') || (pv0==null)) return;
   tot_perc =  $('#totals_dropdown').val(); 
   if  (tot_perc == null) return;
   var pv=pv0.pv;
   var tot_ptr=[]; 
   var precalc_total=[];
   var tot_ind=0;
   //////////////////
   //   try rows totals
    var is_row=null; 
    for (var i=0; i < pv0.opts.rows.length;i++)
        if (pv0.opts.rows[i]==tot_perc) {is_row=i;break;}
    if (is_row != null)
        {
        if (is_row==pv0.opts.rows.length-1)tot_ptr[0]=pv.grand_totals_row;
        else tot_ptr=pv.rows_totals[is_row];
        precalc_totals(precalc_total,tot_ptr);
        
        for (r=pv.col_keys_length; r < pv.data_rows_count ; r++)
            {
            if ((is_row!=pv0.opts.rows.length-1) && (r !=pv.col_keys_length) && (pv.data[r][is_row]!=null)) tot_ind++;
            for (c=pv.row_keys_length; c < pv.data_row_length ; c++)
              {
              pv.data[r][c]=[precalc_val_func(pv.data[r][c]),precalc_total[tot_ind][c]];
              }
            }    
        $('input[name=total]:checkbox', '#pv_dlg_plh'+is_row).attr('checked',true) ;     
        pv0.opts.totals_mask[tot_perc]=1;
        return; //done by rows
        }
    //      end rows
    ////////////
    //      try cols
   var is_col=null;
   for (var i=0; i < pv0.opts.cols.length;i++)
        if (pv0.opts.cols[i]==tot_perc) {is_col=i;break;}
   if (is_col != null)
      {
      if (is_col==pv0.opts.cols.length-1) tot_ptr[0]=pv.grand_totals_col;
      else tot_ptr=pv.cols_totals[is_col];
      precalc_totals(precalc_total,tot_ptr);
      for (c=pv.row_keys_length; c < pv.data_row_length ; c++)
          {
          if ((is_col!=pv0.opts.cols.length-1) && (c !=pv.row_keys_length) && (pv.data[is_col][c]!=null)) tot_ind++;
          for (r=pv.col_keys_length; r < pv.data_rows_count ; r++)
            {
            pv.data[r][c]=[precalc_val_func(pv.data[r][c]),precalc_total[tot_ind][r]];
            }
          } 
      $('input[name=total]:checkbox', '#pv_dlg_plh'+is_col).attr('checked','checked') ;   
      pv0.opts.totals_mask[tot_perc]=1;           
      }       
    //  end cols
    ///////////
      
   }         
function BeforeDraw()
   {
    //preapre colors
    colors=[];
    $('#colors input').each(function(i)
        {
        colors[i]=[parseFloat($(this).attr('level')),$(this).val()]
        }
    )
   //save state
   tot_perc =  $('#totals_dropdown').val();    
   }   
  
function AfterDraw()
   {
      //create totals dropdown 
      $('#totals_dropdown').empty();
      //get cols and rows keys captions 
      var headers=pv0.opts.data_headers;
      var l = pv0.opts.rows.length;
      for (var i=0; i < l; i++)
         $('#totals_dropdown').append('<option value="'+pv0.opts.rows[i]+'">'+headers[pv0.opts.rows[i]]+'</option>');
      var l = pv0.opts.cols.length;
      for (var i=0; i < l; i++)
         $('#totals_dropdown').append('<option value="'+pv0.opts.cols[i]+'">'+headers[pv0.opts.cols[i]]+'</option>');
      //restore state   
      $('#totals_dropdown').val(tot_perc);    
   }   
function print_value_by_total($this,data_indexes) 
      {
       var rclass = $this.styles.Value;
    			if (typeof data_indexes == 'undefined') return  ['',rclass];		;
    			var ret=0;
					if (debug==1) ret='trv'
					if (debug==2) ret='trv'+data_indexes.join(' +');
					if (!debug)
    					{
    							ret = data_indexes[0];	
    				  }
    		  if (data_indexes[1] > 0) ret=Math.round(100*(100*data_indexes[0]/data_indexes[1]))/100;
    		  else ret=0;
    		  return  [ret,rclass];	         
      }    
function save_state()
    {
    serial=pv0.save();
    console.dir(serial);
    }  
function restore()
    {
    pv0.restore(serial);
    pv0.preparePv();   
    pv0.drawData(); 
    }

function export_pivot()
      {
       pv0.getDataForExcel();
      }
      
      
      


function redraw_pivot()
    {
    
    $('#pv').jPivot_drawData();
    
    }
    
    

function prepare_pivot()
    {
    $('#pv').jPivot_preparePv(); 
    }   



       
      </script>
      <style>

         
         #chart2div, #resize_chart_1 { width: 800px; height: 400px;}
div#color_custom{display:block;}         
 div.controlset {display: block; float:left; width: 100%; padding: 0.25em 0;}
div.controlset label, 
 div.controlset input,
div.controlset div { display: inline; float: left; }

div.form-container div.controlset label { width: 100px;}
      </style>
   </head>
   <body>
<table border=1>
    <tr><td>Rows</td><td>Cols</td><td>Aggr</td><td>Filter</td><td>colors</td></tr>
     <tr>
      <td id='qpv_row_keys_placeholder'>herereww</td>
      <td id='qpv_col_keys_placeholder'>herecol</td>
      <td id='pv_agregate_placeholder'>ag</td>
      <td id='pv_filter_placeholder'>f</td>
      <td id="colors" width="120px">
         <div class="controlset"><label for="color3">80</label> <input level="80" type="text" name="color3" value="#008000" /></div>
         <div class="controlset"><label for="color3">50</label> <input level="50" type="text" name="color3" value="#99cc00" /></div>
         <div class="controlset"><label for="color2">30</label> <input level="30" type="text" name="color2" value="#FFFF00" /></div>
         <div class="controlset"><label for="color1">10</label> <input level="10" type="text" name="color1" value="#FF0000" /></div>
      </td>
      <td>
         <input type="checkbox" id="use_custom_filter" value="1">значенение
            <select id="custom_filter_cmp">
            <option value="0">&ge;</option>
            <option value="1">&ne;</option>
            <option value="2">&le;</option>
            <option value="3">=</option>
          </select>
         <input type="text" style="width:20px;" id="custom_filter_val" value="50">
      </td>
      <td>
         <input type="checkbox" checked id="use_percent_by_totals" value="1">
         %from totals by key <select  id="totals_dropdown"></select>
      </td>
     </tr>
</table>
<button name="dr" onclick="redraw_pivot()">Draw</button>
<button name="dr" onclick="prepare_pivot()">Prepare</button>
<button name="dr" onclick="export_pivot()">Excel</button>
<button name="dr" onclick="save_state()">Save</button>
<button name="dr" onclick="restore()">Restore</button>



<!--   graph -->
<script language="javascript" type="text/javascript" src="./jgraph.js"/></script>

      <hr>
      <div id='pv'></div>
      <hr>
     <div id="FS_settindgs">
       | LAbel: N<input type="radio" name="longlabels" value="normal">
       W<input type="radio" name="longlabels" value="WRAP">
       R<input type="radio" name="longlabels" value="ROTATE">
       Rs<input type="radio" name="longlabels" value="ROTATE slang">
       S<input type="radio" name="longlabels" value="Stagger">
       S2<input type="radio" name="longlabels" value="Stagger2">
       | DIsp vals: [in<input type="radio" name="val_ins" value="val_ins">top<input type="radio" name="val_ins" value="val_top">
        non<input type="radio" name="val_ins" value="val_non">]
        [retate val: Y<input type="radio" name="val_norm" value="val_rot">N<input type="radio" name="val_norm" value="val_norm">]
       |color  [auto<input type="radio" name="val_color" value="val_auto"> set<input type="radio" name="val_color" value="val_set">]
     </div>   
     <div><input onclick="redraw()" type="button" name="refresh" value="Refresh"></div>
      <div style="z-index:500" id="resize_chart_1" class="ui-widget-content"><div id='chart1div'></div></div>
      <div id='chart2div'></div>


<script type="text/javascript" src="./math.js"></script>      
   </body>
   