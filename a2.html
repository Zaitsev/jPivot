<!DOCTYPE html>
<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
		<title>jQuery UI Example Page</title>
		<script type="text/javascript" src="./js/jquery-1.3.2.min.js"></script>
		<script type="text/javascript" src="./js/jquery-ui-1.7.2.custom.min.js"></script>
		<script type="text/javascript" src="./jpivot.js"></script>
		<script type="text/javascript" src="./FusionCharts/fusioncharts.js"></script>
		<link type="text/css" href="./css/redmond/jquery-ui-1.7.2.custom.css" rel="stylesheet" />	
		
<!--
//!!!!!!!!!!!!!!!!!!!!!!!!!
////  http://www.fusioncharts.com/forum/Topic5009-47-1.aspx#bm8077
//!!!!!!!!!!!!!!!!!!!!!!
-->

<script type="text/javascript" src="./data_big.js"></script>
		
		<script type="text/javascript">
		  
		  
var month_subst = ['янв','фев','мрт','апр','май','июн','июл','авг','сен','окт','ноя','дек'];

			

var debug=0;

var pv0;


$(document).ready(function()
 {
//////////////////////// ready start 	
	var pivots=$('#pv').jPivot({
			data:data,rows:rows,cols:cols,data_col:data_col,data_headers:data_headers,agregate:agregate
			,filter:filter
	    ,styles:{Key:'class="ui-state-default"'}
	    ,printValue:function(data_indexes) {
		      var rclass = this.styles.Value
    			if (data_indexes==undefined) return  ['',rclass];		;
    		  return  [calc_val(data_indexes) ,rclass];	
	    	
	    	
	    	}
			});  	
	pv0=pivots[0];

	$("#resize_chart_1").resizable({
	 
	 stop:function(){redraw()}
	 ,handles: 'all' 
	});
	

	
	
//////////////////////// ready stop 		
	}	);
	
	
	
function calc_val(data_indexes)
		{
		var ret=0;
		var len =data_indexes.length 
			for (i=0;i < len; i++) 
    			ret += parseFloat(this.data[data_indexes[i]][data_col]);	
    return ret;
		}


      function FC_Rendered(DOMId){
         //If it's our required chart
         if (DOMId=="chart1div"){
            //Simply alert 
            var chartObj = getChartFromId('chart1div');
            //window.alert("Look Ma! I am Column3D and I've finished loading and rendering.");
            return;
         }	
        }
function graph()
		{
		if (pv0==undefined) return null;
		//var pvdata = pv.data;
		var strXML = '';
		pv=pv0.pv;
		opts=pv0.opts;
		var ads='';
    var set = $('#FS_settindgs  [name=longlabels]:checked').val();
    //alert (set);
    if (set=='WRAP') {ads +=" labelDisplay='WRAP' "}
    if (set=='ROTATE') {ads+=" labelDisplay='ROTATE' "}
    if (set=='ROTATE slang') {ads+=" labelDisplay='ROTATE' slantLabels='1' "}
    if (set=='Stagger') {ads+=" labelDisplay='Stagger' "}
    if (set=='Stagger2') {ads+=" labelDisplay='Stagger' staggerLines='4' "}

    set = $('#FS_settindgs  [name=val_ins]:checked').val();
    if (set=='val_ins') {ads+=" placeValuesInside='1' showValues='1'  "}
    if (set=='val_non') {ads+=" showValues='0' "}
    set = $('#FS_settindgs  [name=val_norm]:checked').val();
    if (set=='val_rot') {ads+=" rotateValues='1' "}
    
		 strXML +="<graph  palette='3' "+ads+"   baseFontSize='9' legendPosition='bottom' showLegend='1' xAxisName='"+data_headers[rows[0]]
		 +"'  legendCaption='"+data_headers[cols[0]]+"' numberSuffix='%' decimalPrecision='0' animation='0' " 
		 + "  rotateXAxisName='90' showYAxisValues='1' showDivLineValues='1' yaxismaxvalue='100' bgAngle='270'  bgAlpha='10,10' chartOrder='area,column,  line'>"; 
		var nm,c;
		strXML += "<categories>";
		for (var i=pv.col_keys_length; i< pv.data_rows_count;i++)
			{
			nm=''; for (c= pv.row_keys_length-1; c >=0; c--) nm +=  pv.data[i][c];
			strXML +="<category showLabel='1' toolText='"+nm+"' name='"+nm+"' /><vLine color='FF5904' thickness='2' />";
			}
		strXML +="</categories>";
		set = $('#FS_settindgs  [name=val_color]:checked').val();
		var use_color = (set == 'val_set' );
		//var line=[];
		//for (var row = 0 ; row < pv.data_rows_count; row++) line[row]=[0,0];
		var val;
		for (var col=pv.row_keys_length;col < pv.data_row_length ; col++)
				{
				strXML += "<dataset  renderAs='bar' alpha='100' seriesName='" + pv.data[pv.col_keys_length-1][col] + "' "+(use_color ? " color='"+colors[col-pv.col_keys_length]+"' ":'' )+" >";
				for (row = pv.col_keys_length ; row < pv.data_rows_count; row++)
						{
						if (pv.data[row][col] == undefined)
						  {
							strXML +="<set />";
						  }
						else
						  {
						  v = 0;
						  val=pv.data[row][col];
						  for (var i=0; i < val.length;i++) 
						    v+= parseFloat(opts.data[val[i]][data_col]);
							strXML +="<set value='" + v + "' />";
							//line[row][0] += parseFloat(val);line[row][1]++
						  }
						}
				strXML +="</dataset>";
				} 
/*				
      strXML += "<dataset renderAs='AREA' seriesName='AVG' alpha='5' showValues='0' >";				
      for (row = 0 ; row < pv.data_rows_count; row++)  
          strXML += (line[row][1]) ? "<set value='" + (line[row][0] /  line[row][1]) + "' />" : "<set />";

          
      	strXML +="</dataset>";
*/			
      strXML +="<trendlines>"
			strXML +="<line  alpha='20' startValue='90' endValue='100' color='F7C42A'  isTrendZone='1' displayValue='GOOD' showOnTop='1'/>"
			strXML +="<line  alpha='20' startValue='0'  endValue='25' color='F70000'  isTrendZone='1' displayValue='BAD' showOnTop='0'/>"
			strXML +="</trendlines>";
			strXML +="</graph>"
			return strXML;
      //chart1.render("chart1div");
			//updateChartXML('chart',strXML);
			
		}	
	
var pv;
var chart1;
var chart2;
   var colors=new Array("AFD8F8", "F6BD0F", "8BBA00", "FF8E46","AFD8F8", "F6BD0F", "8BBA00", "FF8E46","AFD8F8", "F6BD0F", "8BBA00", "FF8E46");	
function redraw()
    {
					var strXML = graph();
	
					//var chartObj = getChartFromId('chart1div');
	    //var chart1 = new FusionCharts("./FusionCharts/MSCombi2D.swf", "chart1div"
	    //var chart1 = new FusionCharts("./FusionCharts/MSCombi3D.swf", "chart1div"
      var chart1 = new FusionCharts("./FusionCharts/MSColumnLine3D.swf", "chart1div"
      , $("#resize_chart_1").width(), $("#resize_chart_1").height()
      , "0", 1); 
      chart1.setDataXML(strXML);
      chart1.setTransparent (true);
      chart1.render("chart1div");	
	/*
	var chart1 = new FusionCharts("./FusionCharts/Column3D.swf", "chart1div", "800", "400","0",1);
	chart1.setDataXML(strXML);
	//chart1.setTransparent (true);
	chart1.render("chart1div");		
*/
	var chart2 = new FusionCharts("./FusionCharts/FCF_MSColumn3D.swf", "chart2div", "800", "400","0","1");
	chart2.setDataXML(strXML);
	chart2.setTransparent (true);
	chart2.render("chart2div");		     
    }	

			
		</script>
		<style>
			table.pv_table{border-collapse:collapse;}
			.pv_table td{border:1px solid green; vertical-align:top;}
      .pv_TotalIntersect {background-color:#ECECEC;}
		  .pv_TotalColValue,.pv_TotalRowValue {background-color:silver;;}
		  .pv_TotalColKey  ,.pv_TotalRowKey  {padding:0; background-color:gold;}
		  .pv_Key{background-color:#FEF0D8;}
		  .pv_Value{padding:3px;}
			.pv_dialog {font-size:10px;}
			.pv_KeyHeaderFiltered {color:green; font-weight:bold;}
			div.pv_FliterPlaceholder{padding-bottom:2em;}
			.pv_FliterPlaceholder ul,.pv_KeysRowsPlaceholder,.pv_KeysColsPlaceholder {padding:0px;list-style-type: none; margin:0;}
			.pv_FliterPlaceholder {border:1px solid red; height:2em;}
			.pv_FliterPlaceholder li, #pv_rowkeys_placeholder li {float:left; padding:3px 5px 3px 5px ;}	
			#pv_rowkeys_placeholder{padding-bottom:5px;}
			#pv_colkeys_placeholder{padding-bottom:0px;}
			#pv_filter,#pv_agregate {padding-bottom:5px;}
			
			#chart2div, #resize_chart_1 { width: 800px; height: 400px;}
		</style>
	</head>
	<body>

		<hr>
		<div id='pv'></div>
		<hr>
	  <div id="FS_settindgs">
	    | LAbel: N<input type="radio" name="longlabels" value="normal">
	    W<input type="radio" name="longlabels" value="WRAP">
	    R<input type="radio" name="longlabels" value="ROTATE">
	    Rs<input type="radio" name="longlabels" value="ROTATE slang">
	    S<input type="radio" name="longlabels" value="Stagger">
	    S2<input type="radio" name="longlabels" value="Stagger2">
	    | DIsp vals: [in<input type="radio" name="val_ins" value="val_ins">top<input type="radio" name="val_ins" value="val_top">
	     non<input type="radio" name="val_ins" value="val_non">]
	     [retate val: Y<input type="radio" name="val_norm" value="val_rot">N<input type="radio" name="val_norm" value="val_norm">]
	    |color  [auto<input type="radio" name="val_color" value="val_auto"> set<input type="radio" name="val_color" value="val_set">]
	  </div>	
	  <div><input onclick="redraw()" type="button" name="refresh" value="Refresh"></div>
		<div style="z-index:500" id="resize_chart_1" class="ui-widget-content"><div id='chart1div'></div></div>
		<div id='chart2div'></div>
	</body>