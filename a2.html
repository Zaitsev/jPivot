<!DOCTYPE html>
<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />
		<title>jQuery UI Example Page</title>
		<link type="text/css" href="./css/cupertino/jquery-ui-1.7.2.custom.css" rel="stylesheet" />	
		<script type="text/javascript" src="./js/jquery-1.3.2.min.js"></script>
		<script type="text/javascript" src="./js/jquery-ui-1.7.2.custom.min.js"></script>
		<script type="text/javascript">
/*
(function($) { 
// Private Variables and Functions 
var privateVariable = {}; 
function privateFunction() { 
}; 

// Public Variables and Methods 
$.namespace = { 
        options: {}, 
        publicVariable: []; 
        publicMethod: function() {} 
}; 

// Prototype Methods 
$.fn.extend({ 
                usernameMethod: function() { 
                        return this.each(function() { 
                                        // Persistent Context Variables 
                                        this.contextVariable = 'foo'; 
                        } 
                }. 
                unusernameMethod: function() { 
                        return this.each(function() { 
                                        delete this.contextVariable; 
                        } 
                } 
}); 

//Initialization Code 
$(function() { 
}); 
})(jQuery);
*/			
/*
$.fn.extend({  
    myMethod: function(){...}  
});  
//jQuery("div").myMethod();  
  
$.extend({  
    myMethod2: function(){...}  
});  
//jQuery.myMethod();
*/
var data=[];	
rows = [1,2];	
cols = [3,0];
data_col=4;	
for (i=0;i<3;i++)
	for (j=0;j<3;j++)
		for (k=0;k<2;k++)
			for (n=0;n<3;n++)
			data.push(['s'+i,'b'+j,'q'+k,'qn'+n,'r-s'+i+'-b'+j+'-q'+k+'-qn'+n]);
			
			
			
(function($) { 
// Private Variables and Functions 
function jpv_initialSort(a,b,rows,cols)
		{
		 //Compare "a" and "b" in some fashion, and return -1, 0, or 1
		 //Less than 0: Sort "a" to be a lower index than "b"
		 //Zero: "a" and "b" should be considered equal, and no sorting performed.
		 //Greater than 0: Sort "b" to be a lower index than "a".
		 // rows keep idexes of row keys 
		 // cols keep idexes of col keys 
		 //compare by rows order then cols order
		 for (i=0;i < rows.length;i++)
		 		{
		 		if (a[rows[i]] < b[rows[i]] ) return  1; 
		 		if (a[rows[i]] > b[rows[i]] ) return -1; 
		 		}
		 for (i=0;i < cols.length;i++)
		 		{
		 		if (a[cols[i]] < b[cols[i]] ) return  1; 
		 		if (a[cols[i]] > b[cols[i]] ) return -1; 
		 		}								 		
		 return 0;
		}
function jpv_getIndexOfElementInArray(element, array, addIfAbsent) 
		{
	  for (var i = 0; i < array.length; i++) 
	  	{
	    if (element == array[i])       return i;
	  	}
	  if (addIfAbsent) 
	  	{
	    array.push(element);
	    return (array.length - 1);
	  	}
	  return null;
		}
function jpv_count_keys_span(span_array,key)	
		{
		//create array of [key,count] like  [ [key1,1],[key2,2],[key1,1] ]
		var last_element=span_array.length-1
		if ( (last_element >= 0) && (span_array[last_element][0]==key)) span_array[last_element][1]++;
		else span_array.push([key,1]);
		}	
function jpv_create_2Darray(len)
		{
		var a=[];
		for (i=0;i<len;i++) a.push([]);
		return a;
		}		
		
			
function jpv_pivotDrawData($this)
		{
			  //draw data
			  //start header draw
				var table_data_html=[];
				var opts=$this.opts;
				var pv=$this.pv;
				table_data_html.push('<table class="pv_table">');
				//header colspans
				for (r=0;r < pv.keys_colspan.length;r++)
						{
						len=pv.keys_colspan[r].length;
				table_data_html.push("<tr>\n"); 				
						for (c=0;c<len;c++)
								{
								if ((r==0) && (c==0)) table_data_html.push('<th colspan="'+pv.keys_rowspan.length+'" rowspan="'+pv.keys_colspan.length+'"></th>'); //top left td
								table_data_html.push('<th  class="ui-state-default" colspan="'+pv.keys_colspan[r][c][1]+'">'+pv.keys_colspan[r][c][0]+'</th>');
							  }
				table_data_html.push("</tr>\n"); 
						}
				
				//draw data
				var ind_r=[]; for (r=0; r < pv.keys_rowspan.length;r++) {ind_r.push([0,0]);}
				for (r=0;r< pv.data_rows_count;r++)
			  		{
			  		table_data_html.push("<tr>\n"); 
			  		for (c=0;c< pv.data_row_length;c++)
			  			{
			  					if  (c < pv.keys_rowspan.length)  
			  						{//header
			  						if (ind_r[c][0] == r)
			  							{
			  							table_data_html.push('<th  rowspan = "'+pv.keys_rowspan[c][ind_r[c][1]][1]+'" class="ui-state-default">'+pv.keys_rowspan[c][ind_r[c][1]][0]+'</th>');
			  							ind_r[c][0] += pv.keys_rowspan[c][ind_r[c][1]][1]; //set when next th will be needed by row
			  							ind_r[c][1]++ ; //set for which section we see
			  							}
			  						}
			  					else
			  						{//data
			  						table_data_html.push('<td>'+pv.data[r][c]+'</td>');
			  						}
			  			}
			  		table_data_html.push("</tr>\n");
			  		}
				table_data_html.push('</table>');
				//end draw data
				var str=table_data_html.join(' ');
	
				$($this).append(str);
		
		}
			
			
// Public Variables and Methods declare


// Prototype Methods 
;jQuery.fn.jPivot = function(options)
    {
		var jpivot_opts = options; //pass options to each object
    return this.each(function() { 
				if (this.jpivot_opts) return; //this is me, next...
        // Persistent Context Variables 
        this.contextVariable = 'foo'; 
    		this.opts = $.extend(true, {}, $.fn.jPivot.defaults, jpivot_opts);
				this.pv={}; //context pivot data
    		var tmp_1=0;
				var data_length=this.opts.data.length;
				var data_ptr=this.opts.data;   
				var rows_ptr=this.opts.rows;
				var rows_length=this.opts.rows.length;
				var cols_ptr=this.opts.cols;	
				var cols_length = this.opts.cols.length;
				
    		//sort by rows-cols headers
    		data_ptr.sort(function(a,b){return jpv_initialSort(a,b,rows,cols);});
    				
    		//console.dir(data_ptr); 
    		
				
  			this.pv.rows_keys = jpv_create_2Darray(rows_length); //keep unique values for row keys
  			this.pv.cols_keys = jpv_create_2Darray(cols_length);//keep unique values for col keys
  			var rows_composite_index=[]; //row key value unique composite indexes
  			var cols_composite_index=[]; //col kye value unique composite indexes			
  			var data_row2pv_row=[];  //map raw data rows to pivot rows		
  			var data_row2pv_col=[];  //map raw data cols to pivot cols	
 			
				for (i=0; i < data_length ; i++)
						{
						
						composite_index='';
		  			for (j=0;j<cols_length;j++)	
		  				{
		  				composite_index += data_ptr[i][cols_ptr[j]]+'~~~';  							
		  				jpv_getIndexOfElementInArray(data_ptr[i][cols_ptr[j]],this.pv.cols_keys[j],true);
		  			  }
		  			data_row2pv_col[i]=jpv_getIndexOfElementInArray(composite_index,cols_composite_index,true);
		  			
						composite_index='';
		  			for (j=0;j<rows_length;j++) 
				  			{
				  			composite_index += data_ptr[i][rows_ptr[j]]+'~~~'; 
				  			jpv_getIndexOfElementInArray(data_ptr[i][rows_ptr[j]],this.pv.rows_keys[j],true);
				  		  }
		  			data_row2pv_row[i]=jpv_getIndexOfElementInArray(composite_index,rows_composite_index,true);
		  			
		  			}

	 	
				console.dir(this.pv.cols_keys);
				console.dir(this.pv.rows_keys);
  		 	this.pv.data_rows_count = rows_composite_index.length; 
  		 	this.pv.data_row_length = cols_composite_index.length+rows_length;
  		 	this.pv.data=jpv_create_2Darray(this.pv.data_row_length);
  		 	//init pv_data

  		  var data_header=jpv_create_2Darray(cols_length);
  		  for (i=0;i<data_length;i++)
  		  		{
  		  		for (j=0;j<rows_length;j++) 
  		  				{
  		  				this.pv.data[data_row2pv_row[i]][j]=data_ptr[i][rows_ptr[j]]; //fill row keys
  		  				}
								this.pv.data[data_row2pv_row[i]][data_row2pv_col[i]+rows_length] = data_ptr[i][data_col]; //inset data in its place in row
								if (data_ptr[i][data_col] != null ) for (c=0;c<cols_length;c++)  data_header[c][data_row2pv_col[i] + rows_length] = data_ptr[i][cols_ptr[c]];
  		  		}
  		 
				//rows kyes span
				this.pv.keys_rowspan=jpv_create_2Darray(rows_length);  
				for (r=0;r<this.pv.data_rows_count;r++)	
						for (i=0;i<rows_length;i++) 
								jpv_count_keys_span(this.pv.keys_rowspan[i],this.pv.data[r][i])
				//cols keys span
				this.pv.keys_colspan=jpv_create_2Darray(cols_length);
				for (r=0;r<cols_length;r++)
						for (c=rows_length;c<this.pv.data_row_length;c++)								
								jpv_count_keys_span(this.pv.keys_colspan[r],data_header[r][c]);
				//th_row_cnt.push(key,cnt)
				jpv_pivotDrawData(this);
				return this;                    
    });    	

		}

;$.fn.jPivot.defaults=
		{
		data:null
		,rows:null
		,cols:null
		,data_col:null	
		}	


//Initialization Code 
$(function() { }); 
})(jQuery);			

$(document).ready(function()
	{
	$('#pv').jPivot({data:data,rows:rows,cols:cols,data_col:data_col});  	
	}
	);

			
		</script>
		<style>
			table.pv_table{border-collapse:collapse;border:1px solid red;}
			.pv_table td{border:1px solid green;}
			.pv_table th{border:1px solid silver;}
		</style>
	</head>
	<body>
		<hr>
		<div id='pv'></div>
		<hr>
		<div id='pv2'></div>
	</body>