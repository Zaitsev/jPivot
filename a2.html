<!DOCTYPE html>
<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />
		<title>jQuery UI Example Page</title>
		<link type="text/css" href="./css/redmond/jquery-ui-1.7.2.custom.css" rel="stylesheet" />	
		<script type="text/javascript" src="./js/jquery-1.3.2.min.js"></script>
		<script type="text/javascript" src="./js/jquery-ui-1.7.2.custom.min.js"></script>
		<script type="text/javascript">
/*
(function($) { 
// Private Variables and Functions 
var privateVariable = {}; 
function privateFunction() { 
}; 

// Public Variables and Methods 
$.namespace = { 
        options: {}, 
        publicVariable: []; 
        publicMethod: function() {} 
}; 

// Prototype Methods 
$.fn.extend({ 
                usernameMethod: function() { 
                        return this.each(function() { 
                                        // Persistent Context Variables 
                                        this.contextVariable = 'foo'; 
                        } 
                }. 
                unusernameMethod: function() { 
                        return this.each(function() { 
                                        delete this.contextVariable; 
                        } 
                } 
}); 

//Initialization Code 
$(function() { 
}); 
})(jQuery);
*/			
/*
$.fn.extend({  
    myMethod: function(){...}  
});  
//jQuery("div").myMethod();  
  
$.extend({  
    myMethod2: function(){...}  
});  
//jQuery.myMethod();
*/
var data=[];	
var rows = [0,1];	
var cols = [2,3];
var data_col=4;	
for (i=0;i<3;i++)
	for (j=0;j<3;j++)
		for (k=0;k<2;k++)
			for (n=0;n<3;n++)
			data.push(['s'+i,'b'+j,'q'+k,'qn'+n,'s'+i+'-b'+j+'-q'+k+'-qn'+n]);
			
var data_headers = ['header s','header b','header q','header qn','header datacol']	;	
			
(function($) { 
// Private Variables and Functions
var  jpv_keys_placeholder_update_list_cnt=0; 
function jpv_initialSort(a,b,rows,cols)
		{
		 //Compare "a" and "b" in some fashion, and return -1, 0, or 1
		 //Less than 0: Sort "a" to be a lower index than "b"
		 //Zero: "a" and "b" should be considered equal, and no sorting performed.
		 //Greater than 0: Sort "b" to be a lower index than "a".
		 // rows keep idexes of row keys 
		 // cols keep idexes of col keys 
		 //compare by rows order then cols order
		 for (i=0;i < rows.length;i++)
		 		{
		 		if (a[rows[i]] < b[rows[i]] ) return  1; 
		 		if (a[rows[i]] > b[rows[i]] ) return -1; 
		 		}
		 for (i=0;i < cols.length;i++)
		 		{
		 		if (a[cols[i]] < b[cols[i]] ) return  1; 
		 		if (a[cols[i]] > b[cols[i]] ) return -1; 
		 		}								 		
		 return 0;
		}
function jpv_getIndexOfElementInArray(element, array, addIfAbsent) 
		{
	  for (var i = 0; i < array.length; i++) 
	  	{
	    if (element == array[i])       return i;
	  	}
	  if (addIfAbsent) 
	  	{
	    array.push(element);
	    return (array.length - 1);
	  	}
	  return null;
		}
function jpv_count_keys_span(span_array,key)	
		{
		//create array of [key,count] like  [ [key1,1],[key2,2],[key1,1] ]
		var last_element=span_array.length-1
		if ( (last_element >= 0) && (span_array[last_element][0]==key)) span_array[last_element][1]++;
		else span_array.push([key,1]);
		}	
function jpv_create_2Darray(len)
		{
		var a=[];
		for (i=0;i<len;i++) a.push([]);
		return a;
		}		
function jpv_keys_placeholder_update($this)
		{
		//this func called for each lists (we have 2) so wait until last 
		if (jpv_keys_placeholder_update_list_cnt++ > 0) 
			{
			var rows=[]; var cols=[];
			$('li','#pv_colkeys_placeholder').each(
					function () 
						{ 
						cols.push($(this).attr('value')) 
						}
					);
			$('li','#pv_rowkeys_placeholder').each(
					function () 
						{ 
						rows.push($(this).attr('value')) 
						}
					)	;			
			jpv_keys_placeholder_update_list_cnt=0;
			$this.opts.cols=cols;
			$this.opts.rows=rows;
			//console.dir(rows);
			//console.dir(cols);	
			jQuery.fn.jPivot.preparePv($this);
			jpv_pivotDrawData($this);
			}

		}	
function jpv_keys_placeholder_popup($this,place_id,filter_array)
		{
				var dialog='';
				var dlg_opts={
						autoOpen:false
					 ,title:false
					 ,dialogClass:'pv_dialog'
					 ,buttons: {
										Ok: function() {
											jQuery.fn.jPivot.preparePv($this);
											jpv_pivotDrawData($this);
											$(this).dialog('close');
										}
										,Cancel: function() {
											$(this).dialog('close');
										}
										
									}					 
					 };
				for (k=0;k<filter_array.length;k++)					
						{
						var selector=place_id+k+'dlg';
						dialog='<div id="'+selector+'" style="display:none">';
						dialog +='asc<input type="radio" name="'+selector+'_order" value="A">dsc<input type="radio" name="'+selector+'_order" value="D"><hr>'
						//selector ='#'+selector;
						for (i=0;i<filter_array[k].length;i++)
								{
								dialog +=filter_array[k][i]+'<input type="checkbox" name="'+selector+'_flt[]" value="'+filter_array[k][i]+'"><br>'
								}
						dialog +='</div>';
						$($this).append(dialog);
						$('#'+selector).dialog(dlg_opts);
						$('#'+place_id+' li:eq('+k+')',$this).bind
									(
									"click"
									,{selector:'#'+selector}
									,function(e) 
											{
													$(e.data.selector)
															.dialog('option', 'position', [e.pageX,e.pageY])
															.dialog("open")
											}
									 );
						}
		
		}		
					
function jpv_pivotDrawData($this)
		{
			  //draw data
			  //start header draw
				var table_data_html=[];
				var opts=$this.opts;
				var pv=$this.pv;
				table_data_html.push('<table class="pv_table">');
				//header colspans
				for (r=0;r < pv.keys_colspan.length;r++)
						{
						len=pv.keys_colspan[r].length;
				table_data_html.push("<tr id=\"pv_tr_h_col"+r+"\">\n"); 				
						for (c=0;c<len;c++)
								{
								if ((r==0) && (c==0)) 
									{
									table_data_html.push('<th colspan="'+pv.keys_rowspan.length+'" rowspan="'+pv.keys_colspan.length+'"></th>'); //top left td
									//col keys dragable
									table_data_html.push('<th style="min-width:40px;" rowspan="'+pv.keys_colspan.length+'"><ul class="pv_keys_placeholder" id="pv_colkeys_placeholder">');
									for (i=0;i<opts.cols.length;i++) table_data_html.push('<li  value="'+opts.cols[i]+'"class="ui-state-highlight">'+opts.data_headers[opts.cols[i]] +'</li>');
									table_data_html.push('</ul></th>');
									}
								table_data_html.push('<th  class="ui-state-default" colspan="'+pv.keys_colspan[r][c][1]+'">'+pv.keys_colspan[r][c][0]+'</th>');
							  }
				table_data_html.push("</tr>\n"); 
						}
				//row keys dragable
				table_data_html.push('<tr><th style="min-width:40px;" colspan="'+pv.keys_rowspan.length+'"><ul class="pv_keys_placeholder" id="pv_rowkeys_placeholder">');
				for (i=0;i<opts.rows.length;i++) 
						{
						table_data_html.push('<li value="'+opts.rows[i]+'" class="ui-state-highlight">'+opts.data_headers[opts.rows[i]] +'</li>');
					  }
				table_data_html.push("<td rowspan="+(1+pv.data_rows_count)+"></td><td colspan="+(pv.data_row_length-opts.rows.length)+"></td></ul></tr>\n"); 
				//draw data
				var ind_r=[]; for (r=0; r < pv.keys_rowspan.length;r++) {ind_r.push([0,0]);}
				for (r=0;r< pv.data_rows_count;r++)
			  		{
			  		table_data_html.push("<tr>\n"); 
			  		for (c=0;c< pv.data_row_length;c++)
			  			{
			  					if  (c < pv.keys_rowspan.length)  
			  						{//header
			  						if (ind_r[c][0] == r)
			  							{
			  							table_data_html.push('<th  rowspan = "'+pv.keys_rowspan[c][ind_r[c][1]][1]+'" class="ui-state-default">'+pv.keys_rowspan[c][ind_r[c][1]][0]+'</th>');
			  							ind_r[c][0] += pv.keys_rowspan[c][ind_r[c][1]][1]; //set when next th will be needed by row
			  							ind_r[c][1]++ ; //set for which section we see
			  							}
			  						}
			  					else
			  						{//data
			  						table_data_html.push('<td>'+pv.data[r][c]+'</td>');
			  						}
			  			}
			  		table_data_html.push("</tr>\n");
			  		}
				table_data_html.push('</table>');
				//end draw data
				var str=table_data_html.join(' ');
				
				//draw table
				$($this).empty().append(str);
				
				//create sortable headers
				$('#pv_rowkeys_placeholder, #pv_colkeys_placeholder',$this).sortable(
						{ 
						connectWith: '.pv_keys_placeholder'
						,forcePlaceholderSize: true 
						,forceHelperSize: true
						,helper: 'clone'
						,opacity: '0.6'
						,placeholder: 'ui-state-default'
						,tolerance: 'pointer'
						,cursorAt:  'top,left' 
						,cursor: 'default'
						,deactivate: function(event, ui){jpv_keys_placeholder_update($this)}
						}).disableSelection();
						
				//set height of li
				for (r=0;r < pv.keys_colspan.length;r++)
				$('#pv_colkeys_placeholder li:eq('+r+')',$this).height($("#pv_tr_h_col"+r).height());
				
				//create popup filters
				jpv_keys_placeholder_popup($this,'pv_rowkeys_placeholder',pv.rows_keys);
				jpv_keys_placeholder_popup($this,'pv_colkeys_placeholder',pv.cols_keys)
		}

// Public Variables and Methods declare


// Prototype Methods 
;jQuery.fn.jPivot = function(options)
    {
    var jpivot_opts = options; //pass options to each pivot
    return this.each(function() { 
				if (this.pv) return; //this is me, next...
    		this.opts = $.extend(true, {}, $.fn.jPivot.defaults, jpivot_opts);
				this.pv={}; //context pivot data			
				jQuery.fn.jPivot.preparePv(this)
				jpv_pivotDrawData(this);
				
				return this;                    
    });    	

		}
;jQuery.fn.jPivotDraw =		function($this)
		{

		}		
;jQuery.fn.jPivot.preparePv =		function($this)
		{
        // Persistent Context Variables 
        var pv = $this.pv
    		var tmp_1=0;
				var data_length=$this.opts.data.length;
				var data_ptr=$this.opts.data;   
				var rows_ptr=$this.opts.rows;
				var rows_length=$this.opts.rows.length;
				var cols_ptr=$this.opts.cols;	
				var cols_length = $this.opts.cols.length;
				
  			pv.rows_keys = jpv_create_2Darray(rows_length); //keep unique values for row keys
  			pv.cols_keys = jpv_create_2Darray(cols_length);//keep unique values for col keys				


				
    		//sort by rows-cols headers
    		data_ptr.sort(function(a,b){return jpv_initialSort(a,b,rows_ptr,cols_ptr);});
    				
    		//console.dir(data_ptr); 
    		
				

  			var rows_composite_index=[]; //row key value unique composite indexes
  			var cols_composite_index=[]; //col kye value unique composite indexes			
  			var data_row2pv_row=[];  //map raw data rows to pivot rows		
  			var data_row2pv_col=[];  //map raw data cols to pivot cols	
  			
 				//create filters
 				var cols_data_filter = jpv_create_2Darray(cols_length);
 				for(i=0;i < cols_length; i++ )
 						{
 						$('#pv_colkeys_placeholder'+i+'dlg input:checkbox[checked]').each(function(){cols_data_filter[i].push($(this).val())})
 						}
 				var rows_data_filter = jpv_create_2Darray(rows_length);
 				for(i=0;i < rows_length; i++ )
 						{
 						$('#pv_rowkeys_placeholder'+i+'dlg input:checkbox[checked]').each(function(){rows_data_filter[i].push($(this).val())})
 						} 						
				for (i=0; i < data_length ; i++)
						{
						filtered=false;
						composite_index_col='';
		  			for (j=0;j<cols_length;j++)	
		  				{
		  				//filter by popup dialog
		  				if(jpv_getIndexOfElementInArray(data_ptr[i][cols_ptr[j]],cols_data_filter[j],false) == null)
		  					{
		  						composite_index_col += data_ptr[i][cols_ptr[j]]+'~~~';  							
		  					}
		  				else
		  					{
		  					filtered=true;
		  					}
							jpv_getIndexOfElementInArray(data_ptr[i][cols_ptr[j]],pv.cols_keys[j],true);
		  			  }
		  			
						composite_index_row='';
		  			for (j=0;j<rows_length;j++) 
				  			{
				  			if(jpv_getIndexOfElementInArray(data_ptr[i][rows_ptr[j]],rows_data_filter[j],false) == null)
				  				{
				  				composite_index_row += data_ptr[i][rows_ptr[j]]+'~~~'; 
				  				}
				  			else
				  				{
				  				filtered=true;
				  				}
						    jpv_getIndexOfElementInArray(data_ptr[i][rows_ptr[j]],pv.rows_keys[j],true);
				  		  }
				  	if (! filtered)
				  		{
		  				data_row2pv_row[i]=jpv_getIndexOfElementInArray(composite_index_row,rows_composite_index,true);
							data_row2pv_col[i]=jpv_getIndexOfElementInArray(composite_index_col,cols_composite_index,true);
		  				}
		  			else
		  				{
		  				data_row2pv_row[i]=null;
		  				data_row2pv_col[i]=null;
		  				}
		  			
		  			}

	 	
  		 	pv.data_rows_count = rows_composite_index.length; 
  		 	pv.data_row_length = cols_composite_index.length+rows_length;
  		 	pv.data=jpv_create_2Darray(pv.data_rows_count);
  		 	//init pv_data

  		  var data_header=jpv_create_2Darray(cols_length);
  		  for (i=0;i<data_length;i++)
  		  		{
  		  		if ( (data_row2pv_row[i]==null) || (data_row2pv_col[i]==null) ) continue; //row filtered
  		  		for (j=0;j<rows_length;j++) 
  		  				{
  		  				pv.data[data_row2pv_row[i]][j]=data_ptr[i][rows_ptr[j]]; //fill row keys
  		  				}
								pv.data[data_row2pv_row[i]][data_row2pv_col[i]+rows_length] = data_ptr[i][data_col]; //inset data in its place in row
								if (data_ptr[i][data_col] != null ) for (c=0;c<cols_length;c++)  data_header[c][data_row2pv_col[i] + rows_length] = data_ptr[i][cols_ptr[c]];
  		  		}
  		 
				//rows kyes span
				pv.keys_rowspan=jpv_create_2Darray(rows_length);  
				for (r=0;r < pv.data_rows_count;r++)	
						for (i=0; i < rows_length; i++) 
								jpv_count_keys_span(pv.keys_rowspan[i],pv.data[r][i])
				//cols keys span
				pv.keys_colspan=jpv_create_2Darray(cols_length);
				for (r=0; r < cols_length; r++)
						for (c=rows_length; c < pv.data_row_length; c++)								
								jpv_count_keys_span(pv.keys_colspan[r],data_header[r][c]);
				//th_row_cnt.push(key,cnt)			
		}

;$.fn.jPivot.defaults=
		{
		data:null
		,rows:null
		,cols:null
		,data_col:null
		,data_headers:null
		}	


//Initialization Code 
$(function() { }); 
})(jQuery);			

$(document).ready(function()
	{
	$('#pv').jPivot({data:data,rows:rows,cols:cols,data_col:data_col,data_headers:data_headers});  	
	}
	);

			
		</script>
		<style>
			.pv_dialog {font-size:10px;}
			table.pv_table{border-collapse:collapse;border:1px solid red;}
			.pv_table td{border:1px solid green;}
			.pv_table th{border:1px solid silver;}
			.pv_keys_placeholder {padding:0px;list-style-type: none; margin:0;}
			#pv_rowkeys_placeholder li {float:left;}	
			#pv_rowkeys_placeholder{padding-bottom:5px;}
			#pv_colkeys_placeholder{padding-bottom:1px;}
		</style>
	</head>
	<body>
		<hr>
		<div id='pv'></div>
		<hr>
		<div id='pv2'></div>
	</body>